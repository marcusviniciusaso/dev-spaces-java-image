ARG UDI_IMAGE=registry.redhat.io/devspaces/udi-rhel9:3.22

FROM ${UDI_IMAGE}

USER 0

ARG OCP_VERSION=4.18.24
ARG HELM_VERSION=v3.16.2
ARG KIND_VERSION=v0.26.0

RUN set -euo pipefail; \
    arch="${TARGETARCH:-}"; \
    if [ -z "$arch" ]; then \
      uarch="$(uname -m)"; \
      case "$uarch" in \
        x86_64) arch="amd64" ;; \
        aarch64|arm64) arch="arm64" ;; \
        *) echo "Unsupported arch: $uarch" && exit 1 ;; \
      esac; \
    fi; \
    echo "$arch" > /tmp/ARCH

RUN set -euo pipefail; \
    PM="microdnf"; command -v microdnf >/dev/null 2>&1 || PM="dnf"; \
    REQUIRED="gnupg2 ca-certificates unzip zip jq git tree bash-completion iputils vim-enhanced"; \
    $PM install -y $REQUIRED; \
    if $PM install -y traceroute; then \
        echo "traceroute instalado"; \
    else \
        echo "traceroute não encontrado, usar fallback (tracepath)"; \
    fi; \
    $PM clean all

# ---- Fallbacks (traceroute e lsb-release/redhat-lsb-core) ----
RUN set -euo pipefail; \
    # ---- Fallback traceroute ----
    if ! command -v traceroute >/dev/null 2>&1; then \
        echo "Wrapper para traceroute..."; \
        printf '#!/bin/bash\n' > /usr/local/bin/traceroute; \
        printf 'echo "[WARN] traceroute não disponível. Usando tracepath." >&2\n' >> /usr/local/bin/traceroute; \
        printf 'exec tracepath "${1:-8.8.8.8}"\n' >> /usr/local/bin/traceroute; \
        chmod +x /usr/local/bin/traceroute; \
    fi; \
    \
    # ---- Fallback lsb-release/redhat-lsb-core ----
    if ! command -v lsb_release >/dev/null 2>&1; then \
        echo "Script lsb_release customizado..."; \
        printf '#!/bin/bash\n' > /usr/local/bin/lsb_release; \
        printf 'source /etc/os-release\n' >> /usr/local/bin/lsb_release; \
        printf 'case "${1:-}" in\n' >> /usr/local/bin/lsb_release; \
        printf '  -a|"") echo "Distributor ID:\t${ID}"; echo "Description:\t${PRETTY_NAME}"; echo "Release:\t${VERSION_ID}"; echo "Codename:\t${VERSION_CODENAME:-}";;\n' >> /usr/local/bin/lsb_release; \
        printf '  -si) echo "${ID}" ;;\n' >> /usr/local/bin/lsb_release; \
        printf '  -sr) echo "${VERSION_ID}" ;;\n' >> /usr/local/bin/lsb_release; \
        printf '  -sd) echo "${PRETTY_NAME}" ;;\n' >> /usr/local/bin/lsb_release; \
        printf '  *) echo "Uso: lsb_release [-a|-si|-sr|-sd]" >&2; exit 2 ;;\n' >> /usr/local/bin/lsb_release; \
        printf 'esac\n' >> /usr/local/bin/lsb_release; \
        chmod +x /usr/local/bin/lsb_release; \
    fi

# ---- Azure CLI ----
RUN set -euo pipefail; \
    rpm --import https://packages.microsoft.com/keys/microsoft.asc; \
    if command -v dnf >/dev/null 2>&1; then \
      dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm; \
      dnf install -y azure-cli; \
      dnf clean all; \
    else \
      echo "dnf não encontrado; instale azure-cli manualmente." && exit 1; \
    fi

# ---- oc + kubectl ----
RUN set -euo pipefail; \
    curl -fsSL -o /tmp/ocp-client.tar.gz \
      "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable-4.18/openshift-client-linux.tar.gz"; \
    tar -C /tmp -xzf /tmp/ocp-client.tar.gz; \
    install -m 0755 /tmp/oc /usr/local/bin/oc; \
    if [ -f /tmp/kubectl ]; then install -m 0755 /tmp/kubectl /usr/local/bin/kubectl; fi; \
    rm -rf /tmp/oc /tmp/kubectl /tmp/README.md /tmp/ocp-client.tar.gz

# ---- helm ----
RUN set -euo pipefail; \
    arch="$(cat /tmp/ARCH)"; \
    curl -fsSL -o /tmp/helm.tgz \
      "https://get.helm.sh/helm-${HELM_VERSION}-linux-${arch}.tar.gz"; \
    tar -C /tmp -xzf /tmp/helm.tgz; \
    install -m 0755 "/tmp/linux-${arch}/helm" /usr/local/bin/helm; \
    rm -rf /tmp/helm.tgz "/tmp/linux-${arch}"

# ---- kind ----
RUN set -euo pipefail; \
    arch="$(cat /tmp/ARCH)"; \
    curl -fsSL -o /usr/local/bin/kind \
      "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-${arch}"; \
    chmod 0755 /usr/local/bin/kind

# ---- CEKit ----
RUN set -euo pipefail; \
    if command -v pip3 >/dev/null 2>&1; then \
      pip3 install --no-cache-dir -U cekit; \
    else \
      echo "pip3 não encontrado; instale python3-pip" && exit 1; \
    fi

# ---- podman ----
RUN set -euo pipefail; \
    if ! command -v podman >/dev/null 2>&1; then \
      if command -v dnf >/dev/null 2>&1; then dnf install -y podman && dnf clean all; \
      else echo "podman ausente e dnf indisponível" && exit 1; fi; \
    fi

RUN set -euo pipefail; \
    mkdir -p /etc/bash_completion.d; \
    (kubectl completion bash > /etc/bash_completion.d/kubectl || true); \
    (oc completion bash > /etc/bash_completion.d/oc || true); \
    (helm completion bash > /etc/bash_completion.d/helm || true)

# ---- nota de versao ----
RUN set -euo pipefail; \
    cat > /etc/devspaces-linux-release <<'EOF'
devspaces_distro:
  type: base
  version: "1.1.1"
  release_date: "2026-02-20"
os:
  name: "Red Hat Enterprise Linux"
  version: "9.6"
EOF
RUN chmod 0644 /etc/devspaces-linux-release

# ---- Repositories ----
# ---- public-yum-central ----
RUN cat <<EOF > /etc/yum.repos.d/nexus-repo
[nexus-interno]
name=Repositorio Interno Nexus
baseurl=NEXUS_BASEURL_PLACEHOLDER
enabled=1
gpgcheck=0
sslverify=0
priority=1
EOF

RUN chmod 666 /etc/yum.repos.d/nexus-repo

LABEL org.opencontainers.image.title="Dev Spaces Custom UDI" \
      org.opencontainers.image.description="UDI customizada para Dev Spaces 3.22" \
      org.opencontainers.image.source="https://github.com/marcusviniciusaso/custom-udi" \
      org.opencontainers.image.vendor="Red Hat (sample)" \
      org.opencontainers.image.version="1.1.1"

USER 10001

CMD ["bash", "-lc", "sleep infinity"]
